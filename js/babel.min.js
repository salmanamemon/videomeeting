function Babel(e){var t="babel";var n=cryptico.generateRSAKey(1024);var r=cryptico.publicKeyString(n);var i={username:e,publicKey:r};var s={};var o={};var u=function(){};var a=function(){};var f=function(t){if(t.recipient===e){var r=cryptico.decrypt(t.message.cipher,n).plaintext;parsedMsg={msgID:t.msgID,plaintext:r,TTL:t.ttl,sender:t.sender,recipient:t.recipient};if(o[t.sender]===undefined){o[t.sender]=[parsedMsg]}else{o[t.sender].push(parsedMsg)}u(parsedMsg);p(t.sender,t.msgID,t.ttl)}};var l=function(e){if(e.action==="join"||e.action==="state-change"){if("data"in e){s[e.data.username]=e.data.publicKey}else{c.here_now({channel:t,state:true,callback:h})}a()}else if(e.action==="timeout"||e.action==="leave"){delete s[e.uuid];a()}};var c=PUBNUB.init({publish_key:"demo",subscribe_key:"demo",uuid:e,ssl:true});c.subscribe({channel:t,callback:f,presence:l,state:i});var h=function(e){s={};for(var t=0;t<e.uuids.length;t++){if("state"in e.uuids[t]){s[e.uuids[t].state.username]=e.uuids[t].state.publicKey}}a()};var p=function(e,t,n){setTimeout(function(){if(e===t){for(var n=0;n<o[e].length;n++){if(o[e][n].msgID===t){o[e].splice(n,1);break}}}},1e3*n)};return{sendMessage:function(n,r,i){if(n in s){var a=r;var f=s[n];r=cryptico.encrypt(r,f);c.uuid(function(s){c.publish({channel:t,message:{recipient:n,msgID:s,sender:e,message:r,ttl:i},callback:function(){parsedMsg={msgID:s,plaintext:a,TTL:i,sender:e,recipient:n};if(o[n]===undefined){o[n]=[parsedMsg]}else{o[n].push(parsedMsg)}u(parsedMsg);p(n,s,i)}})})}},onMessage:function(e){u=e},onPresence:function(e){a=e},listUsers:function(){return s},returnMessages:function(){return o},myKey:function(){return n},quit:function(){c.unsubscribe({channel:t})}}}